if("undefined"==typeof WCN)var WCN={};WCN.ns=function(){var e=arguments,a=null,t,d,n;for(t=0;t<e.length;t+=1)for(n=e[t].split("."),a=window,d=0;d<n.length;d+=1)a[n[d]]=a[n[d]]||{},a=a[n[d]];return a},WCN.ns("WCN.labels"),"undefined"!=typeof WCN&&WCN||(WCN={}),WCN.constraint={add_word_length:function(e,a){a=parseInt(a,10);var t=$("#"+e),d=function(t){"string"!=typeof t&&(t="");var d=t.replace(/^\s+/,"").replace(/\s+$/,"").split(/\s+/),n=d.length;""===d&&(n=0),$("#"+e+"_counter").html(n>a?'<span class="page_error" style="display:inline">'+n+"</span>":n)};t.hasClass("bbcode")&&tinyMCE.getInstanceById(e)?WCN.Watcher(function(){return tinyMCE.getInstanceById(e).getContent()},d):t.watchChange(d)},add_char_length:function(e,a){WCN.log("add_char_length : "+e),$("#"+e).keyup(function(){var t=$("#"+e).val().length;if(t>a){var d=$("#"+e).val();d=d.substring(0,d.length-1),$("#"+e).val(d)}$("#"+e+"_counter").html($("#"+e).val().length)}),$("#"+e).trigger("keyup")}},WCN.dynviz={added_ev_handler:new Array,reinit_for_real:function(){WCN.dynviz.eForms||(this.added_ev_handler=[],this.initialise())},initialise:function(){if(WCN.dynviz.data){var e=function(e){1!=WCN.dynviz.added_ev_handler[e]&&($("#"+e).change(function(e){WCN.dynviz.update_fields()}),$("input[name="+e+"]:radio").click(function(e){WCN.dynviz.update_fields()}),$("input[name="+e+"]:checkbox").click(function(e){WCN.dynviz.update_fields()}),WCN.dynviz.added_ev_handler[e]=!0)},a=/^(.+).formdata.(\d+):(\d+|any|current):(\d+|any|current).(.+)$/;for(var t in WCN.dynviz.data.dtrees)for(var d in WCN.dynviz.data.dtrees[t].dpaths){var n=a.exec(d),i=n[1],o=n[2],r=n[3],l=WCN.dynviz.data.form_instance,f=n[5];if("current"==r)for(var p=1;1e3>p;p++){var s=i+".formdata."+o+":"+p+":"+l+"."+f,_=WCN.dynviz.data.dpath_to_dfield[s];if(!_)break;e(_)}else{var s=i+".formdata."+o+":"+r+":"+l+"."+f,_=WCN.dynviz.data.dpath_to_dfield[s];_&&e(_)}}WCN.dynviz.update_fields()}},update_fields:function(){for(var e in WCN.dynviz.data.dtrees)if(WCN.dynviz.data.dtrees[e]&&WCN.dynviz.data.dtrees[e].formlet_comps)for(var a=0;a<WCN.dynviz.data.dtrees[e].formlet_comps.length;a++){var t=WCN.dynviz.data.dtrees[e].expression,d=WCN.dynviz.data.dtrees[e].formlet_comps[a],n=d.split("_",2)[1],i=WCN.dynviz.data.form_instance;t=t.replace(/formdata.(\d+):(\d+|current):(current)./g,"formdata.$1:$2:"+i+"."),t=t.replace(/formdata.(\d+):(current):/g,"formdata.$1:"+n+":");var o="#formlet_component_"+WCN.dynviz.data.dtrees[e].formlet_comps[a];WCN.dynviz._evaluate_expresion(t)?($(o+" :input").attr("disabled",!1),$(o).show()):($(o+" :input").attr("disabled",!0),$(o).hide())}$("form.eform_form").trigger("eform.update_vizability")},doIN:function(e,a){for(var t=0;t<a.length;t++)if(a[t]==e)return 1;return 0},runDEFINED:function(e){return WCN.dynviz.get_value_with_dpath(e)?1:0},runAVG:function(e){for(var a=0,t=0,d=0;d<e.length;d++)null!=e[d]&&(a+=1,t+=e[d]);return 0==a?0:t/a},runSUM:function(e){for(var a=0,t=0;t<e.length;t++)null!=e[t]&&(a+=e[t]);return a},_evaluate_expresion:function(expression){return eval(expression)},get_value_with_dpath:function(e){var a=WCN.dynviz.data.dpath_to_dfield[e],t=String(WCN.formtools.get_field_values(a));return"-1"===t?void 0:t}};var df_re=new RegExp("datafield_(\\d+)_(\\d+)_(\\d+)");WCN.map={df_field_ids:new Array,field_options:new Array,added_ev_handler:new Object,map_data_fields:new Object,get_df_values:function(e,a,t,d){var n=[],i={},o={},r=e.datafield_to_lookup_map[a];e:for(var l in e.map){var f=e.map[l];if(!("pref_set"===e.type&&1==WCN.map_enable_unique&&e.unique_col&&f[e.unique_col]&&e.unique[f[e.unique_col]]&&e.unique[f[e.unique_col]]!==d)){for(var p in e.depends[a]){var s=e.depends[a][p];if(s!==r)for(var _ in e.lookup_to_datafield_map[s]){var u=e.lookup_to_datafield_map[s][_];if("undefined"==typeof o[u]){var m=WCN.formtools.get_smallest_datafield(u,t,d);null==m&&(m=""),o[u]=m}var v=o[u];if(v){var c=v.attr("id");if("undefined"==typeof i[c]){var C;C=v.filter("p").length>0?""+v.data("field_value"):v.val(),null==C&&(C=""),i[c]=C}var C=i[c];if("object"==typeof C){for(var N=!1,W=0;W<C.length;W++)if(C[W]==f[s]){N=!0;break}if(!N)continue e}else if(f[s]!==C)continue e}}}n.push(f[r])}}return n},add_map_handler:function(e,a,t,d){var n=df_re.exec(e),i=n[1],o=n[2],r=n[3],l=$("input[name=_redis_form_session_id]",$("#"+e).closest("form")).val();for(var f in WCN.map.data){if(WCN.map.map_data_fields[f]||(WCN.map.map_data_fields[f]=new Object),1!==WCN.map.data[f].init){if("pref_set"===WCN.map.data[f].type&&1==WCN.map_enable_unique){WCN.map.data[f].unique={},WCN.map.data[f].unique_col="id",WCN.map.data[f].depends_most=null,WCN.map.data[f].depends_least=null;for(var p in WCN.map.data[f].depends)($("#datafield_"+p+"_1_1").parent().parent().parent().hasClass("mandatory")||$("#datafield_"+p+"_1_1").parent().parent().hasClass("mandatory"))&&(WCN.map.data[f].depends_most?(WCN.map.data[f].depends[p].length>WCN.map.data[f].depends[WCN.map.data[f].depends_most].length&&(WCN.map.data[f].depends_most=p),WCN.map.data[f].depends_least?WCN.map.data[f].depends[p].length<WCN.map.data[f].depends[WCN.map.data[f].depends_least].length&&(WCN.map.data[f].depends_least=p):WCN.map.data[f].depends_least=p):WCN.map.data[f].depends_most=p)}WCN.map.data[f].init=1}if(WCN.map.data[f].datafield_to_lookup_map[i]){WCN.map.map_data_fields[f][e]=1;for(var s in WCN.map.data[f].depends[i]){var _=WCN.map.data[f].depends[i][s];for(var u in WCN.map.data[f].lookup_to_datafield_map[_]){var m=WCN.map.data[f].lookup_to_datafield_map[_][u],v=WCN.formtools.get_smallest_datafield(m,o,r);v&&!function(a,t){if(1!==WCN.map.data[a].eform||!d||!WCN.map.data[a].is_big_map&&WCN.map.data[a].map&&0!==WCN.map.data[a].map.length)v.change(function(t,d){WCN.console.info("This "+t.target.id+" has been changed. We need to update "+e+" according to map "+a);var n=df_re.exec(t.target.id),l=n[1],f=n[2],p=n[3],s=WCN.map.get_df_values(WCN.map.data[a],i,o,r);WCN.formtools.set_field_options(e,s),$("form.eform_form").trigger("eform.field_viz_change")});else{if(WCN.map.added_ev_handler[v.attr("id")])return;v.change(function(e,a){if(WCN.console.info("This "+e.target.id+" has been changed. We will make an AJAX call to fetch updated data for all fields"),"undefined"!=typeof a||a||(a={}),!a.first_run){var t={};l&&(t._redis_form_session_id=l),t[e.target.id]=WCN.formtools.get_field_values(e.target.id),("undefined"==typeof t[e.target.id]||0===t[e.target.id].length)&&(t[e.target.id]=[" "]),WCN.ajax({url:d+WCN.eform_page,dataType:"json",type:"post",data:t,success:function(e){var a=new RegExp("(\\d+)_(\\d+)_(\\d+)");for(var t in e)for(var d=a.exec(t),n=d[1],i=parseInt(d[3]);1e3>i;){var r="datafield_"+n+"_"+o+"_"+i,l="datafield_"+m+"_"+o+"_"+i,f=$("#"+r)[0],p=$("#"+l)[0];if(!f||p&&l!=v.attr("id"))break;WCN.formtools.new_select_values(r,e[t]),$("#"+r).parent().fadeOut(function(){$(this).fadeIn()}),i+=1}$("form.eform_form").trigger("eform.field_viz_change")}})}})}WCN.map.added_ev_handler[v.attr("id")]=v}(f,_)}}if("pref_set"===WCN.map.data[f].type&&WCN.map.data[f].depends_most&&WCN.map.data[f].depends_most===i){var c=f;$("#"+e).change(function(e){return function(a,t){WCN.log("Calling Update Unique Cols : "+i+" ("+e+")"),WCN.map.update_unique_cols(WCN.map.data[e],$(this).attr("id"))}}(f))}}}},update_unique_cols:function(e,a){var t=df_re.exec(a),d=t[1],n=t[2],i=t[3],o=0,r=null;WCN.log("UPDATE UNIQUE COLS: '"+d+"' => '"+n+"' => '"+i+"'");var l="datafield_"+e.depends_most+"_"+n+"_"+i,f=WCN.formtools.get_field_values(l),p={},s=0,_=0;if(f.length>0){p[e.depends_most]=f,s++;for(var m in e.depends[e.depends_most]){var v=WCN.map.lookup_to_df(e,e.depends[e.depends_most][m])[0],c=WCN.formtools.get_smallest_datafield(v,n,i);if(c)if(c.closest(".form_value").is(":visible")){var C=WCN.formtools.get_field_values(c.attr("id"));C.length>0&&(s++,p[v]=C)}else _++}}if(s+_<e.depends[e.depends_most].length+1)for(u in e.unique)e.unique[u]===i&&(delete e.unique[u],o=1);else e:for(var N in e.map){for(var m in e.map[N]){var a=WCN.map.lookup_to_df(e,m);if(a&&(a=a[0],"undefined"!=typeof p[a]&&p[a])){var W=0;for(var g in p[a])e.map[N][m]===p[a][g]&&(W=1);if(0===W)continue e}}if(e.unique[e.map[N][e.unique_col]]!==i){e.unique[e.map[N][e.unique_col]]=i,o=1;for(var m in e.unique)e.unique[m]===i&&m!==e.map[N][e.unique_col]&&delete e.unique[m];break e}}if(o)for(var a in WCN.map.added_ev_handler){var h=new RegExp("datafield_(\\d+)_(\\d+)_(\\d+)"),t=h.exec(a),y=t[1],$=t[2],b=t[3];if("undefined"!=typeof e.datafield_to_lookup_map[y]){if(b!==i){var k=WCN.map.get_df_values(e,y,$,b);WCN.formtools.set_field_options(a,k)}}else WCN.log("Skipping df "+y+" as it's not in this map.")}},update_fields:function(){WCN.log("----- Running update fields");for(var e in WCN.map.map_data_fields)for(var a in WCN.map.map_data_fields[e]){var t=$("#"+a);(t.closest(".form_value").is(":visible")||t.parent().parent().hasClass("use_hidden_map_field"))&&t.trigger("change",[{first_run:1}])}var d=new Array,n=new Array;for(var i in WCN.map.data)for(var o in WCN.map.data[i].depends){var r=WCN.map.df_field_ids[o];for(var l in r){var f=r[l].id,p=r[l].instance,s=$("#"+f);s.hide(),s.parent().append("<div>Loading...</div>");var _=1;for(x=0;x<WCN.map.data[i].depends[o].length;x++){var u=WCN.map.lookup_to_df(i,WCN.map.data[i].depends[o][x]),m=0;if(WCN.map.df_field_ids[u]){for(var v=0,c,C=0;C<WCN.map.df_field_ids[u].length;C++)if(1==WCN.map.df_field_ids[u][C].instance&&(c=WCN.map.df_field_ids[u][C]),WCN.map.df_field_ids[u][C].instance===p){v=1;var N=WCN.formtools.get_field_values(WCN.map.df_field_ids[u][C].id);N.length>0&&(m=1)}if(0===v&&1!=p&&c){var N=WCN.formtools.get_field_values(c.id);N.length>0&&(m=1)}}0==m&&(_=0)}if(_)for(var W in WCN.map.data[i].map){for(var g=WCN.map.data[i].map[W],h=1,y=0;y<WCN.map.data[i].depends[o].length;y++){for(var u=WCN.map.lookup_to_df(i,WCN.map.data[i].depends[o][y]),N=[],b=WCN.map.df_to_lookup(i,u),v=0,c,C=0;C<WCN.map.df_field_ids[u].length;C++)1==WCN.map.df_field_ids[u][C].instance&&(c=WCN.map.df_field_ids[u][C]),WCN.map.df_field_ids[u][C].instance===p&&(N=WCN.formtools.get_field_values(WCN.map.df_field_ids[u][C].id),v=1);0===v&&1!=p&&c&&(N=WCN.formtools.get_field_values(c.id));for(var k=0;k<N.length;k++){var w=0;g[b]==N[k]&&(w=1),1!=w&&(h=0)}}if(h){var b=WCN.map.df_to_lookup(i,o),z=g[b];"undefined"!=typeof n[f]&&n[f]?n[f].push(z):(n[f]=new Array,n[f].push(z))}else"undefined"!=typeof n[f]&&n[f]||(n[f]=[])}else window.setTimeout(function(){$("#"+f).show(),$("#"+f).get(0).disabled=!0,$("#"+f).parent().children().remove("div")},500)}}for(var x=0;x<n.length;x++)WCN.log("updating data field "+l),n[x].length>0?WCN.formtools.set_field_options(l,n[x]):$("#"+l).get(0).disabled=!0,window.setTimeout(function(){var e=$("#"+l);e.show(),e.get(0).disabled=!1,e.parent().children().remove("div")},500);$("form.eform_form").trigger("eform.field_viz_change")},lookup_to_df:function(e,a){var t;return t="object"==typeof e?e:WCN.map.data[e],t.lookup_to_datafield_map[a]},df_to_lookup:function(e,a){var t=WCN.map.data[e];return t.datafield_to_lookup_map[a]}},WCN.formtools={get_smallest_datafield:function(e,a,t){for(;t>=1;){var d=document.getElementById("datafield_"+e+"_"+a+"_"+t);if(null!=d)return $(d);t-=1}return null},set_field_options:function(e,a){var t=$("#"+e),d=t.get(0);if("undefined"!=typeof d){d.disabled=!1;var n=WCN.formtools.get_field_values(e);if("select-one"==d.type||"select-multiple"==d.type){if("undefined"!=typeof WCN.map.field_options[e]&&WCN.map.field_options[e])for(var i=0;i<WCN.map.field_options[e].length;i++)WCN.map.field_options[e][i].added="0";else{WCN.map.field_options[e]=new Array;for(var i=0;i<d.options.length;i++)if(d.options[i].value){var o={value:d.options[i].value,label:d.options[i].text,added:"0"};WCN.map.field_options[e].push(o)}}var r;r=d&&d.options&&d.options[0]&&d.options[0].innerHTML&&""===d.options[0].value?['<option value="">',d.options[0].innerHTML,"</option>"]:[];for(var i=0;i<WCN.map.field_options[e].length;i++)for(var l=0;l<a.length;l++)if(WCN.map.field_options[e][i].value==a[l]&&"0"==WCN.map.field_options[e][i].added){r.push('<option value="',WCN.map.field_options[e][i].value,'"');for(var f=0;f<n.length;f++)if(WCN.map.field_options[e][i].value==n[f]){r.push(' selected="selected"');break}r.push(">",WCN.map.field_options[e][i].label,"</option>"),WCN.map.field_options[e][i].added="1"}t.html(r.join("")),t.data("select2")&&t.closest(".form_value").is(":visible")&&t.trigger("change",[{first_run:1,set_field_options:!0}])}else if("checkbox"==d.type||"radio"==d.type){var p=null,s=d,_=null;if(_=null==s?idOrName:s.name,null==_)return null;for(var u=document.getElementsByTagName("input"),i=0;i<u.length;i++)for(var m=u[i],l=0;l<a.length;l++)if(("checkbox"==m.type||"radio"==m.type)&&m.name==_){if(m.value==a[l]){m.disabled=!1;break}m.disabled=!0}return p}}},new_select_values:function(e,a){var t=$("#"+e),d=t.get(0);d.disabled=!1;var n=WCN.formtools.get_field_values(e);if("select-one"==d.type||"select-multiple"==d.type){d.options.length=d&&d.options&&d.options[0]&&d.options[0].innerHTML&&""===d.options[0].value?1:0;for(var i=0;i<a.length;i++){var o=document.createElement("option");o.setAttribute("value",a[i].v),o.innerHTML=a[i].l,d.appendChild(o)}t.data("select2")&&t.closest(".form_value").is(":visible")&&t.trigger("change",[{first_run:1,set_field_options:!0}])}},get_field_values:function(e){var a=$("#"+e).get(0);if($("#"+e).is(":disabled"))return"-1";if(!a){if($("input[name="+e+"]").get(0)){var t=[];return $("input[name="+e+"]:checked").each(function(){t.push($(this).val())}),t}return"-1"}if("select-one"==a.type||"select-multiple"==a.type){for(var d=new Array,n=0;n<a.options.length;n++)a.options[n].selected&&""!=a.options[n].value&&d.push(a.options[n].value);return d}return"text"==a.type||"textarea"==a.type||"hidden"==a.type?a.value:"checkbox"==a.type&&a.checked?a.value:void 0},enableInLineHelp:function(){$("a.field-info").each(function(e,a){var t=$(a);t.children("img").attr("alt","");var d={length:0};t.attr("title","").hover(function(){if(d.length)d.length&&d.stop().fadeTo("fast",1);else{d=$("<span />",{"class":"field_help_text"}).hide().load(a.href+" #cn",function(e){d.stop().fadeIn("fast").show()});var e=t.offset();d.css({border:"1px solid black",padding:"5px","border-radius":"5px","background-color":"white",position:"absolute",left:e.left+25,top:e.top}),$("body").append(d)}},function(){d.length&&d.stop().fadeOut("fast")}).click(function(e){e.preventDefault()})})}};